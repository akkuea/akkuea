name: API - Quality and Security CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'akkuea-defi-rwa/apps/api/**'
      - '.github/workflows/api-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'akkuea-defi-rwa/apps/api/**'
      - '.github/workflows/api-ci.yml'

env:
  NODE_VERSION: '20'
  BUN_VERSION: 'latest'

jobs:
  build-and-test:
    name: Build and Test API
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: ${{ env.BUN_VERSION }}
        
    - name: Install dependencies
      run: |
        cd akkuea-defi-rwa/apps/api
        bun install --frozen-lockfile || {
          echo "Dependency installation failed, trying without frozen lockfile..."
          bun install
        }
        
    - name: Type checking
      run: |
        cd akkuea-defi-rwa/apps/api
        bun run type-check
        
    - name: Linting with ESLint
      run: |
        cd akkuea-defi-rwa/apps/api
        bun run lint
        
    - name: Format checking with Prettier
      run: |
        cd akkuea-defi-rwa/apps/api
        bun run format
        
    - name: Build application
      run: |
        cd akkuea-defi-rwa/apps/api
        bun run build

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      
    - name: Install dependencies
      run: |
        cd akkuea-defi-rwa/apps/api
        bun install
        
    - name: Audit dependencies
      run: |
        cd akkuea-defi-rwa/apps/api
        
        # Check for vulnerabilities in dependencies
        bun audit

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      
    - name: Install dependencies
      run: |
        cd akkuea-defi-rwa/apps/api
        bun install
        
    - name: Complexity analysis
      run: |
        cd akkuea-defi-rwa/apps/api
        
        # Install complexity analyzer
        bun add -D complexity-report
        
        # Run complexity analysis
        bunx complexity-report src/ --format json --output complexity.json || true
        
        # Check for overly complex functions
        if [ -f "complexity.json" ]; then
          echo "Complexity analysis completed"
          cat complexity.json
        fi
        