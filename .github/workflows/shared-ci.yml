name: Shared Library - Quality and Security CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'akkuea-defi-rwa/apps/shared/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'akkuea-defi-rwa/apps/shared/**'

env:
  NODE_VERSION: '20'
  BUN_VERSION: 'latest'

jobs:
  build-and-test:
    name: Build and Test Shared Library
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: ${{ env.BUN_VERSION }}
        
    - name: Cache Bun dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.bun/install/cache
          node_modules/.cache
        key: ${{ runner.os }}-bun-${{ hashFiles('**/package.json') }}
        restore-keys: |
          ${{ runner.os }}-bun-
          
    - name: Install dependencies
      run: |
        cd akkuea-defi-rwa/apps/shared
        /Users/runner/.bun/bin//Users/runner/.bun/bin/bun install
        
    - name: Type checking
      run: |
        cd akkuea-defi-rwa/apps/shared
        /Users/runner/.bun/bin/bun run build:types
        
    - name: Linting with ESLint
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Install ESLint if not present
        if ! bunpm list eslint &>/dev/null; then
          bun add -D eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin
        fi
        
        # Run linting
        bunx eslint src/ --ext .ts --fix-dry-run
        
    - name: Format checking with Prettier
      run: |
        cd akkuea-defi-rwa/apps/shared
        /Users/runner/.bun/bin/bunx prettier --check "src/**/*.{ts,js,json}"
        
    - name: Build library
      run: |
        cd akkuea-defi-rwa/apps/shared
        /Users/runner/.bun/bin/bun run build
        
        # Verify build output
        if [ ! -d "dist" ]; then
          echo "Error: Build directory not created"
          exit 1
        fi
        
        # Check if types are generated
        if [ ! -f "dist/index.d.ts" ]; then
          echo "Error: Type definitions not generated"
          exit 1
        fi
        
    - name: Run unit tests
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Install test framework if needed
        if ! bunpm list bun-test &>/dev/null; then
          bun add -D bun-types
        fi
        
        # Run tests (using Node.js test runner for simplicity)
        bun test
        
    - name: Test library consumption
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Create test consumer
        mkdir -p test-consumer
        cd test-consumer
        
        # Initialize test project
        bun init -y
        
        # Install local package
        bun add ../dist
        
        # Test importing the library
        echo 'import { ValidationService } from "../dist/index.js"; console.log("Import test:", ValidationService.validateStellarAddress("G"))' > test-import.mjs
        bun run test-import.mjs
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: shared-dist
        path: akkuea-defi-rwa/apps/shared/dist/
        retention-days: 7

  security-audit:
    name: Security Audit
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      
    - name: Install dependencies
      run: |
        cd akkuea-defi-rwa/apps/shared
        /Users/runner/.bun/bin//Users/runner/.bun/bin/bun install
        
    - name: Audit dependencies
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Check for vulnerabilities
        bun audit
        
        # Additional security checks
        bunx audit-ci --moderate || true
        
    - name: Check for secrets in code
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Scan for potential secrets
        echo "Scanning for potential secrets..."
        
        # Common secret patterns
        if grep -r -E "(API_KEY|SECRET|TOKEN|PASSWORD|PRIVATE_KEY)" src/ --exclude-dir=node_modules; then
          echo "Warning: Potential secret patterns found in source code"
          exit 1
        fi
        
        # Check for hardcoded Stellar keys (common issue)
        if grep -r "S[A-Z0-9]{55}" src/ 2>/dev/null; then
          echo "Warning: Potential Stellar private key found"
          exit 1
        fi
        
    - name: Validate Stellar addresses and keys
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Ensure no hardcoded addresses in utils
        echo "Validating Stellar utilities..."
        
        if grep -r "G[A-Z0-9]{55}" src/ | grep -v "validate\|example\|test"; then
          echo "Warning: Hardcoded Stellar address found"
          exit 1
        fi

  type-safety:
    name: Type Safety Analysis
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      
    - name: Install dependencies
      run: |
        cd akkuea-defi-rwa/apps/shared
        /Users/runner/.bun/bin//Users/runner/.bun/bin/bun install
        
    - name: Strict TypeScript compilation
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Compile with strictest settings
        bunx tsc --noEmit --strict --noImplicitAny --noImplicitReturns --noImplicitThis
        
    - name: Type coverage analysis
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Generate type coverage report
        bun add -D type-coverage
        
        # Check type coverage (require 100% for shared library)
        bunx type-coverage --strict --detail
        
    - name: Interface completeness check
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Ensure all exports have proper types
        echo "Checking export completeness..."
        
        # Get all exports
        EXPORTS=$(grep -o "export.*{" src/index.ts)
        echo "Exports: $EXPORTS"
        
        # Check type definitions
        if [ -f "dist/index.d.ts" ]; then
          echo "Type definitions found"
          # Basic syntax check
          bunx tsc --noEmit dist/index.d.ts
        fi

  api-compatibility:
    name: API Compatibility Test
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      
    - name: Install dependencies
      run: |
        cd akkuea-defi-rwa/apps/shared
        /Users/runner/.bun/bin//Users/runner/.bun/bin/bun install
        
        cd ../../api
        /Users/runner/.bun/bin//Users/runner/.bun/bin/bun install
        
    - name: Test API integration
      run: |
        cd akkuea-defi-rwa/apps/api
        
        # Import shared library in API context
        node -e "
        try {
          const shared = require('../shared/dist/index.js');
          const { ValidationService } = shared;
          console.log('✅ Shared library imported successfully');
          console.log('✅ ValidationService available:', typeof ValidationService);
          console.log('✅ Stellar validation works:', ValidationService.validateStellarAddress ? 'Yes' : 'No');
        } catch (error) {
          console.error('❌ Import failed:', error.message);
          process.exit(1);
        }
        "
        
    - name: Test frontend integration
      run: |
        cd akkuea-defi-rwa/apps/webapp
        
        # Test importing in frontend context
        /Users/runner/.bun/bin//Users/runner/.bun/bin/bun install
        
        node -e "
        try {
          const shared = require('../shared/dist/index.js');
          console.log('✅ Frontend integration test passed');
        } catch (error) {
          console.error('❌ Frontend integration failed:', error.message);
          process.exit(1);
        }
        "

  code-quality:
    name: Code Quality
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      
    - name: Install dependencies
      run: |
        cd akkuea-defi-rwa/apps/shared
        /Users/runner/.bun/bin//Users/runner/.bun/bin/bun install
        
    - name: Code complexity analysis
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Simple complexity check
        echo "Analyzing code complexity..."
        
        # Find large functions (>50 lines)
        find src/ -name "*.ts" -exec wc -l {} + | while read lines file; do
          if [ $lines -gt 50 ]; then
            echo "Warning: Large function in $file ($lines lines)"
          fi
        done
        
    - name: Documentation quality
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Check if all exports are documented
        echo "Checking documentation quality..."
        
        # Count exports vs documented items
        EXPORT_COUNT=$(grep -c "export" src/index.ts)
        DOC_COMMENT_COUNT=$(grep -c "/\*\*" src/*.ts)
        
        echo "Exports: $EXPORT_COUNT"
        echo "Documentation blocks: $DOC_COMMENT_COUNT"
        
        if [ $DOC_COMMENT_COUNT -lt $EXPORT_COUNT ]; then
          echo "Warning: Some exports may lack documentation"
        fi
        
    - name: Test coverage verification
      run: |
        cd akkuea-defi-rwa/apps/shared
        
        # Run tests with coverage
        bun test --coverage || true
        
        # Verify reasonable coverage (90% for shared library)
        echo "Shared library should maintain high test coverage"